<!doctype html><html lang=en>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=HandheldFriendly content="True">
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta http-equiv=cache-control content="no-transform">
<meta http-equiv=cache-control content="no-siteapp">
<meta name=generator content="Hugo 0.89.4">
<link rel="shortcut icon" href=https://cdn.jsdelivr.net/gh/dsrkafuu/dsr-cdn-main@1/images/favicons/dsrca.ico>
<title>Data Oriented Design - LMJW Blog</title>
<meta name=author content="LMJW">
<meta name=description content="A minimal Hugo theme with nice theme color.">
<meta name=keywords content="cpp">
<meta property="og:title" content="Data Oriented Design">
<meta name=twitter:title content="Data Oriented Design">
<meta property="og:type" content="article">
<meta property="og:url" content="https://lmjw.github.io/post/2019-11-24-data-oriented-design/"><meta property="og:description" content="Data Oriented Design Check out the video. This explains the AOS and SOA very well. data orientied design
 The following code is a common pattern in Object oriented programming.
struct Entity{ v3 postion, v3 velocity, int flag, virtual void update() } struct Player: public Entity{ float life, float mana, void update() override; } struct Monster: public Entity{ float life, void update() override; } sturct Door: public Entity{ bool current_status, float open_target, void update(); }  There are few problems with this approach:
  Memory allocation. In this objected orientied approach, because we inherited Entity objects and added some fields in child object, the size of the new Object can have different sizes.">
<meta name=twitter:description content="Data Oriented Design Check out the video. This explains the AOS and SOA very well. data orientied design
 The following code is a common pattern in Object oriented programming.
struct Entity{ v3 postion, v3 velocity, int flag, virtual void update() } struct Player: public Entity{ float life, float mana, void update() override; } struct Monster: public Entity{ float life, void update() override; } sturct Door: public Entity{ bool current_status, float open_target, void update(); }  There are few problems with this approach:
  Memory allocation. In this objected orientied approach, because we inherited Entity objects and added some fields in child object, the size of the new Object can have different sizes."><meta property="og:image" content="https://lmjw.github.io/img/og.png">
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://lmjw.github.io/img/og.png"><meta property="article:published_time" content="2019-11-24T00:00:00+00:00"><meta property="article:modified_time" content="2019-11-24T00:00:00+00:00">
<style>@media(prefers-color-scheme:dark){body[data-theme=auto] img{filter:brightness(60%)}}body[data-theme=dark] img{filter:brightness(60%)}</style>
<link rel=stylesheet href=https://lmjw.github.io/assets/css/fuji.min.css>
</head>
<body data-theme=auto data-theme-auto=true>
<script data-cfasync=false>var fujiThemeData=localStorage.getItem('fuji_data-theme');fujiThemeData?fujiThemeData!=='auto'&&document.body.setAttribute('data-theme',fujiThemeData==='dark'?'dark':'light'):localStorage.setItem('fuji_data-theme','auto')</script>
<header>
<div class="container-lg clearfix">
<div class="col-12 header">
<a class=title-main href=https://lmjw.github.io/>LMJW Blog</a>
<span class=title-sub>My notes.</span>
</div>
</div>
</header>
<main>
<div class="container-lg clearfix">
<div class="col-12 col-md-9 float-left content">
<article>
<h2 class="post-item post-title">
<a href=https://lmjw.github.io/post/2019-11-24-data-oriented-design/>Data Oriented Design</a>
</h2>
<div class="post-item post-meta">
<span><i class="iconfont icon-today-sharp"></i>&nbsp;2019-11-24</span>
<span><i class="iconfont icon-file-tray-sharp"></i>&nbsp;658 words</span>
<span><i class="iconfont icon-time-sharp"></i>&nbsp;4 minutes</span>
<span><i class="iconfont icon-pricetags-sharp"></i>&nbsp;<a href=/tags/cpp>cpp</a>&nbsp;</span>
</div>
<div class="post-content markdown-body">
<h1 id=data-oriented-design>Data Oriented Design</h1>
<p>Check out the video. This explains the AOS and SOA very well.
<a href="https://www.youtube.com/watch?v=ScvpoiTbMKc" target=_blank>data orientied design</a></p>
<hr>
<p>The following code is a common pattern in Object oriented programming.</p>
<pre><code class=language-Cpp>struct Entity{
  v3 postion,
  v3 velocity,
  int flag,

  virtual void update()
}

struct Player: public Entity{
  float life,
  float mana,

  void update() override;
}

struct Monster: public Entity{
  float life,

  void update() override;
}

sturct Door: public Entity{
  bool current_status,
  float open_target,

  void update();
}
</code></pre>
<p>There are few problems with this approach:</p>
<ol>
<li>
<p>Memory allocation. In this objected orientied approach, because we inherited Entity objects and added some fields in child object, the size of the new Object can have different sizes. So, we may ends up as many different size objects which will imply random heap allocation in memory. (just like objects are putting every where in memory without organize) So when we want to access these objects, the speed of accessing all these object can be a bit slow.</p>
</li>
<li>
<p>L1 Cache miss. Let&rsquo;s say we want to update the postion of a player, we use the equation <code>'p = p + v*dt</code>. To update the object state, we will need to know two fields stored in the obejct, the <code>position</code> and the <code>velocity</code> of the object. But, to access these fields, we will need to get all the structure in the L1 cache. So in the end, we fetched all the struct into L1 cache, but we only used two fields. This is something called caches misses.</p>
</li>
<li>
<p>The object oriented approach is also messy in terms of state management, and this can be expensive. Say a player hit a monster, the monster has its own state like how much life it has. But because of object oriented design, the state is kept private to monster, so eventually monster will need to have a method like <code>get_damage</code>. Eventually, we will need to load <code>player</code> object and then call the <code>get_damage</code> method of monster object. But what all we do is probably manipulate the <code>life</code> field, but we will need to fully load the <code>player</code> struct and <code>monster</code> struct, which may contain many other fields and method.</p>
</li>
</ol>
<hr>
<p>So, what is data oriented design and how can it solve this problem?</p>
<p>The difference of object oriented design and data oriented design is a difference between <code>Array Of Struts</code>(AOS) and <code>Strut of Arrays</code>(SOA). Lets see how AOS and SOA are stored in memory</p>
<pre><code class=language-Cpp>struct ood{
  type_A a,
  type_B b,
  type_C c
}

struct dod{
  type_A a[1000],
  type_B b[1000],
  type_C c[1000]
}

// memory
// OOD (Object orentied design)
// ...|a|b|c|...|a|b|c|...|a|b|c|...
//
// DOD (data orentied design)
// ...|a|a|a|...|b|b|b|...|c|c|c|...
//
// say we need to update a&amp;b field for all structs. The first OOD case, we will
// need to go through all the structs, fetch the whole struct into L1 cache, then
// update field a,b, then iterate all the structs. Although we read C field in the
// L1 Cache, we did not use it at all. We have about 33% cach missing rate. This
// number is more significant if the object is bigger.
//
// But for DOD case, we will just need to pull all field of a and b, and just updates
// these fields. We have almost 100% cache usagage, which will be much faster.
</code></pre>
<p>For the latter case, because in the memory, the same data is more closely aligned with same type, therefore it is more easy for cpu to do hardware optimization(hardware prefetching). In addition to that, this kind of structure makes SIMD (single instruction mulitple data) very easy.</p>
<p>What is SIMD?</p>
<p>SIMD is kind like hardware circle for some instruction which runs really fast and in paralle. SIMD allows same instructs for different data to execute in paralle to speed up the computation. SIMD is supported by some modern CPUs. With data orentied design, it can better utilize the SIMD to do the calculation as all our data is aligned nicely in memory.</p>
</div>
</article>
<div class="license markdown-body">
<blockquote>
<p>Unless otherwise noted, the content of this site is licensed under <a rel=license href=http://creativecommons.org/licenses/by-nc-sa/4.0/ target=_blank>CC BY-NC-SA 4.0</a>.</p>
</blockquote>
</div>
</div>
<aside class="col-12 col-md-3 float-left sidebar">
<div class="sidebar-item sidebar-pages">
<h3>Pages</h3>
<ul>
<li>
<a href=/>Home</a>
</li>
<li>
<a href=/archives/>Archives</a>
</li>
<li>
<a href=/search/>Search</a>
</li>
</ul>
</div>
<div class="sidebar-item sidebar-links">
<h3>Links</h3>
<ul>
<li>
<a href=https://github.com/LMJW target=_blank><span>GitHub</span></a>
</li>
</ul>
</div>
<div class="sidebar-item sidebar-tags">
<h3>Tags</h3>
<div>
<span>
<a href=/tags/bash/>bash</a>
</span>
<span>
<a href=/tags/cli/>CLI</a>
</span>
<span>
<a href=/tags/cpp/>cpp</a>
</span>
<span>
<a href=/tags/deep-learning/>deep-learning</a>
</span>
<span>
<a href=/tags/docker/>docker</a>
</span>
<span>
<a href=/tags/gmp/>GMP</a>
</span>
<span>
<a href=/tags/golang/>golang</a>
</span>
<span>
<a href=/tags/grpc/>grpc</a>
</span>
<span>
<a href=/tags/kernel/>kernel</a>
</span>
<span>
<a href=/tags/key-mapping/>key-mapping</a>
</span>
<span>
<a href=/tags/kubernetes/>Kubernetes</a>
</span>
<span>
<a href=/tags/markdown-cheatsheet/>Markdown CheatSheet</a>
</span>
<span>
<a href=/tags/network/>network</a>
</span>
<span>
<a href=/tags/openssl/>openssl</a>
</span>
<span>
<a href=/tags/os/>OS</a>
</span>
<span>
<a href=/tags/python/>python</a>
</span>
<span>
<a href=/tags/subprocess/>subprocess</a>
</span>
<span>
<a href=/tags/tool/>tool</a>
</span>
<span>
<a href=/tags/tools/>Tools</a>
</span>
</div>
</div>
<div class="sidebar-item sidebar-toc">
<h3>Table of Contents</h3><nav id=TableOfContents></nav></div>
</aside>
</div>
<div class=btn>
<div class=btn-menu id=btn-menu>
<i class="iconfont icon-grid-sharp"></i>
</div>
<div class=btn-toggle-mode>
<i class="iconfont icon-contrast-sharp"></i>
</div>
<div class=btn-scroll-top>
<i class="iconfont icon-chevron-up-circle-sharp"></i>
</div>
</div>
<aside class=sidebar-mobile style=display:none>
<div class=sidebar-wrapper>
<div class="sidebar-item sidebar-pages">
<h3>Pages</h3>
<ul>
<li>
<a href=/>Home</a>
</li>
<li>
<a href=/archives/>Archives</a>
</li>
<li>
<a href=/search/>Search</a>
</li>
</ul>
</div>
<div class="sidebar-item sidebar-links">
<h3>Links</h3>
<ul>
<li>
<a href=https://github.com/LMJW target=_blank><span>GitHub</span></a>
</li>
</ul>
</div>
<div class="sidebar-item sidebar-tags">
<h3>Tags</h3>
<div>
<span>
<a href=/tags/bash/>bash</a>
</span>
<span>
<a href=/tags/cli/>CLI</a>
</span>
<span>
<a href=/tags/cpp/>cpp</a>
</span>
<span>
<a href=/tags/deep-learning/>deep-learning</a>
</span>
<span>
<a href=/tags/docker/>docker</a>
</span>
<span>
<a href=/tags/gmp/>GMP</a>
</span>
<span>
<a href=/tags/golang/>golang</a>
</span>
<span>
<a href=/tags/grpc/>grpc</a>
</span>
<span>
<a href=/tags/kernel/>kernel</a>
</span>
<span>
<a href=/tags/key-mapping/>key-mapping</a>
</span>
<span>
<a href=/tags/kubernetes/>Kubernetes</a>
</span>
<span>
<a href=/tags/markdown-cheatsheet/>Markdown CheatSheet</a>
</span>
<span>
<a href=/tags/network/>network</a>
</span>
<span>
<a href=/tags/openssl/>openssl</a>
</span>
<span>
<a href=/tags/os/>OS</a>
</span>
<span>
<a href=/tags/python/>python</a>
</span>
<span>
<a href=/tags/subprocess/>subprocess</a>
</span>
<span>
<a href=/tags/tool/>tool</a>
</span>
<span>
<a href=/tags/tools/>Tools</a>
</span>
</div>
</div>
<div class="sidebar-item sidebar-toc">
<h3>Table of Contents</h3>
<nav id=TableOfContents></nav>
</div>
</div>
</aside>
</main>
<footer>
<div class="container-lg clearfix">
<div class="col-12 footer">
<span>&copy; 2020-2021
<a href=https://lmjw.github.io/>LMJW</a>
| <a href=https://github.com/LMJW/lmjw.github.io>Source code</a>
| Powered by <a href=https://github.com/dsrkafuu/hugo-theme-fuji/ target=_blank>Fuji-v2</a> & <a href=https://gohugo.io/ target=_blank>Hugo</a>
</span>
</div>
</div>
</footer>
<script defer src=https://cdn.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js></script>
<script defer src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script>
<script defer src=https://cdn.jsdelivr.net/npm/prismjs@1.23.0/components/prism-core.min.js></script>
<script defer src=https://cdn.jsdelivr.net/npm/prismjs@1.23.0/plugins/autoloader/prism-autoloader.min.js></script>
<script defer src=/assets/js/fuji.min.js></script>
</body>
</html>